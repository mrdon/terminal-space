<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta charset=utf8>
    <style>
        @font-face {
          font-family: 'ansi-bbs';
          src: url('ASCII.ttf');
        }
    </style>
    <link rel="stylesheet" href="ansi.css" type="text/css" media="all"/>
    <style>
        html, body {
            background-color: #333;
            color: white;
            font-family: monospace;
            margin: 0;
            padding: 0;
        }

        #console {
            height: 400px;
            width: 750px;
            position: relative;
            background-color: black;
            border: 2px solid #CCC;
            margin: 0 auto;
            margin-top: 50px;
            font-family: 'ansi-bbs', monospace, sans-serif;
        }

        .jqconsole {
            padding: 10px;
            padding-bottom: 10px;
        }

        .jqconsole-cursor {
            background-color: #999;
        }

        .jqconsole-blurred .jqconsole-cursor {
            background-color: #666;
        }

        .jqconsole-prompt {
            color: #0d0;
        }

        .jqconsole-old-prompt {
            color: #0b0;
            font-weight: normal;
        }

        .jqconsole-input {
            color: #dd0;
        }

        .jqconsole-old-input {
            color: #bb0;
            font-weight: normal;
        }

        .brace {
            color: #00FFFF;
        }

        .paran {
            color: #FF00FF;
        }

        .bracket {
            color: #FFFF00;
        }

        .jqconsole-composition {
            background-color: red;
        }
    </style>
</head>
<body>
<div id="console"></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js" type="text/javascript"
        charset="utf-8"></script>
<script src="jqconsole.js"></script>
<script src="escapes.js"></script>
<script>
    propStartingWith = function (obj, prefix) {
        var res = [];
        for (var m in obj) {
            if (m.indexOf(prefix) === 0) {
                res.push(m);
            }
        }
        return res;
    };

    $(function () {

//        cursor = new escapes.Cursor();
//       cursor.parse("", {
//            onEscape    : cursor.escape,
//            onLiteral   : cursor.write,
//            onComplete  : function() {}
//        });
//        document.body.appendChild(cursor.canvas);

        // Creating the console.
        var header = 'Welcome to pytw!\n' +
                'This is just a simple clone of a popular BBS game that probably won\'t be taken farther.\n';
        window.jqconsole = $('#console').jqconsole(header, 'JS> ');
        old_append = jqconsole.Append
        jqconsole.Append = function(node) {
            root = $('<div/>');
            root.append(node);
            $(".jqconsole-ansi-hidden:contains(input={)", root).each(function() {
                param_str = $(this).contents().get(0).nodeValue.substring(6);
                console.log(param_str);
                params = JSON.parse(param_str);
                $wrap = $(this).nextUntil(".jqconsole-ansi-hidden:contains(<end>)")
                        .andSelf()
                        .wrapAll("<a class='ansi-input-link' data-value='" + params.value + "' href='#' />");
            });

            old_append.call(jqconsole, root.contents());
        };

        $('#console').on('click', '.ansi-input-link', function(e) {
            e.preventDefault();
            socket.send($(this).data('value'));
            socket.send('\n');
        });

        var socket = new WebSocket('ws://'+window.location.host);
        socket.onerror = function (error) {
            console.log('WebSocket Error: ' + error);
        };
        socket.onmessage = function (event) {
            var message = event.data;
            jqconsole.Write(message);
            cursor.parse(message, {
                onEscape    : cursor.escape,
                onLiteral   : cursor.write,
                onComplete  : function() {}
            });
        };

        jqconsole.SetKeyPressHandler(function (e) {
            socket.send(String.fromCharCode(e.which));
        });

        function getInput() {
            jqconsole.Input(function(e) {
                socket.send('\n');
                getInput()
            });
        }
        getInput();

    });
</script>

</body>
</html>
